<!DOCTYPE html>
<html>
<meta http-equiv="Content-Security-Policy" content="img-src * 'self' data:; default-src *; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' 'unsafe-eval'">

<meta name="viewport"   content="width=device-width, initial-scale=1.0, user-scalable=no">
  <head>

  	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Prius Taxi</title>

	<script type="text/javascript" charset="utf-8" src="cordova.js"></script>

	<script type="text/javascript" charset="utf-8" src="io.js"></script>
<script type="text/javascript" charset="utf-8" src="func.js"></script>
	

<script type="text/javascript" charset="utf-8">

var mystatus=0;

document.addEventListener("deviceready", onDeviceReady, false);

var myid=0;

var wlon=44.7689831;
var wlat=41.7089554;
var MyUser="nouser";
var MyPass="nopass";
var MyZoom=17;

var MyLat;
var MyLong;
var MyAlt;
var MyHead;
var MySpeed;
var MyAcc;
var started;
started=0;

function onBackKeyDown() 
	{
	if (curwindow==1)
		{
		show_map();
		}
	}

function onMenuDown() 
	{
	if (curwindow==0)
		{
		show_settings();
		}
	}


function onSearchDown() 
	{
	if (myself==0)
		{
		setme();
		}
	}

function onVolumeDown()
	{
	zoomme(-1);
	}

function onVolumeUp()
	{
	zoomme(1);
	}

var dataex=0;

var xtile;
var ytile;

var mousex;
var mousey;
var omousex;
var omousey;
	
var sx;
var sy;

var canacX;
var canacY;
var inter='none';

var inpause=0;

sx=getscreenw();
sy=getscreenh();
var myself=0;


var gamehttp;
if (window.XMLHttpRequest) {gamehttp=new XMLHttpRequest();}
else if (window.ActiveXObject) {gamehttp=new ActiveXObject('Microsoft.XMLHTTP');}
else {alert('Your browser does not support XMLHTTP!');}
gamehttp.onreadystatechange=update_data;


var userids = new Array();
var usernames = new Array();
var userlongs = new Array();
var userlats = new Array();
var useralts = new Array();
var userspeeds = new Array();
var userheads = new Array();
var userlasts = new Array();


var cache_ignore=0;
var cache_ignore_wifi=1;


var cur_down_i=0;
var cur_down_ii=0;
var down_complete=1;
var check_complete=1;
var file_downing=0;
var LT_finished=0;
var watchID = null;
// ------------------------------
function onDeviceReady() 
	{

	console.log("device ready, checking connection");
	checkConnection();

	document.addEventListener("pause", onPause, false);
	//document.addEventListener("backbutton", onBackKeyDown, false);
	//document.addEventListener("menubutton", onMenuDown, false);
	//document.addEventListener("searchbutton", onSearchDown, false);
	document.addEventListener("volumedownbutton", onVolumeDown, false);
	document.addEventListener("volumeupbutton", onVolumeUp, false);

	console.log("device ready, getting position");
	navigator.geolocation.getCurrentPosition(onSuccess, onError, {enableHighAccuracy: true,  maximumAge:0});
	var opts = { timeout: 5000, enableHighAccuracy: true, maximumAge:0};
	watchID = navigator.geolocation.watchPosition(onWatchSuccess, onError, opts);
	document.addEventListener("resume", onResume, false);
	
	console.log("device ready, dealing with record file");
	
	kc=checkIfFileExists("locdata.txt");

	if (started==0)	
		{
		Start();
		}
	setmypos();
	}
// ------------------------

var updatacounter=0;
var uplimit=5;
function MainProg()
	{
	console.log("main prog: "+started);
	if (started==1)
		{	
		console.log("I am running");
		updatacounter++;
		if (updatacounter>uplimit)
			{
			UpData();
			updatacounter=0;
			}
		if (myself==1 && inpause==0)
			{
			wlon=MyLong;
			wlat=MyLat;
			setmypos();
			}
		}
		setTimeout("MainProg();",1000);
	}

var taxilong=0;
var taxilat=0;
var taxiname="";
var notified=0;

var chatis="";

function update_data()
	{		
	if(gamehttp.readyState == 4)
		{
		mr=gamehttp.responseText;
		if (mr!="")
			{
			console.log("data received from server: "+mr);
			if (mr=="register")		
				{
				
				console.log("register received");
				Start();
				}
			else if (mr.substring(0,4)=="chat")
				{
				console.log("chat receive: "+mr);
				a=mr.split("|");
				chatis=a[1];
				console.log("chat is:"+chatis);
				document.getElementById("chat_txt").innerHTML=chatis;
				}
			else
				{
				users.length=0;
				
				a=mr.split("|");
				if (a[0]=="searching_taxi")
					{
					notified=0;
					change_status(1);

					}
				else if (a[0]=="taxi_moving")
					{
					notified=0;
					change_status(2);
					b=a[1].split(";");
					if (b[0]!="")
						{
						taxilong=parseFloat(b[0]);
						taxilat=parseFloat(b[1]);
						taxiname=b[2];
						
						}
					}
				else if (a[0]=="taxi_arrived")
					{

					change_status(3);
					b=a[1].split(";");
					if (b[0]!="")
						{
						taxilong=parseFloat(b[0]);
						taxilat=parseFloat(b[1]);
						taxiname=b[2];
						document.getElementById("taxi_number").innerHTML="ბორტის ნომერი: "+taxiname;
						if (notified==0)
							{
							window.plugin.notification.local.schedule({
							id:         "321123",  // A unique id of the notifiction
							text:    "თქვენი ტაქსი მოვიდა და გელოდებათ",  // The message that is displayed
							title:      "ტაქსი მოვიდა",  // The title of the message  
						
							});
							notified=1;
							}

						}
					}
				else if (a[0]=="taxi_waiting")
					{
					
					change_status(4);
					b=a[1].split(";");
					if (b[0]!="")
						{
						taxilong=parseFloat(b[0]);
						taxilat=parseFloat(b[1]);
						taxiname=b[2];
						}
					}
				else if (a[0]=="you_moving")
					{
					notified=0;

					change_status(5);
					b=a[1].split(";");
					if (b[0]!="")
						{
						taxilong=parseFloat(b[0]);
						taxilat=parseFloat(b[1]);
						taxiname=b[2];
						}
					}
				else
					{
					if (mystatus>0)
						{
						notified=0;
						document.getElementById("taxibox").style.visibility="hidden";
						uplimit=5;
						document.getElementById("call_but").style.display="inline";
						document.getElementById("arrived_screen").style.display="none";
						change_status(0);
						}
					check_chat(parseInt(mr));
					}
				
				if (inpause==0)	{DrawUsers();}


				}
			}
		}
	}

function check_chat(chatid)
	{
	if (chatid!=last_chat)
		{
		last_chat=chatid;
		url="http://design.ge/geotaxi/chat.php?req=1&myid="+myid;
		
		console.log("request chat: "+url);
		gamehttp.open('GET',url,true);
		gamehttp.send(null);
		}
	}

function UpData()
	{
	if (myid==0 || myid=="")
		{	
		myid=Math.floor(Math.random()*100000000);	
		WriteData();
		}

	if (MyUser!="nouser")
		{    
		url="http://design.ge/geotaxi/upload.php?uname="+MyUser+"&pass="+MyPass+"&lat="+MyLat+"&long="+MyLong+"&alt="+MyAlt+"&head="+MyHead+"&speed="+MySpeed+"&passive="+inpause+"&myid="+myid;		
		}
	else
		{
		url="http://design.ge/geotaxi/upload.php?passive="+inpause+"&myid="+myid+"&lat="+MyLat+"&long="+MyLong+"&alt="+MyAlt+"&head="+MyHead+"&speed="+MySpeed;
		}
	console.log("just upload: "+url);
//	document.getElementById('erorebi').innerHTML="uname="+MyUser+"&pass="+MyPass+"&lat="+MyLat+"&long="+MyLong+"&alt="+MyAlt+"&head="+MyHead+"&speed="+MySpeed;
	gamehttp.open('GET',url,true);
	gamehttp.send(null);
	
	
	}

function Start()
	{
	console.log("Start / END");
	if (started==0)
		{started=1;  MainProg();}  // document.getElementById('mainb').innerHTML="STOP";
	else
		{//started=0;
		} //  document.getElementById('mainb').innerHTML="START";

	}

function onPause()
	{
	console.log("on pause");
//	if (started==0) 
		//{
	if (mystatus==0 || mystatus==5)
		{
		started=0;
		clearWatch();
		WriteData();
		inpause=1;
		}

	}

function onResume() 
	{
	console.log("on resume");
	if (inpause==1)
		{
		inpause=0;
		}

	if (started==0)
		{
		checkConnection();
	
		var opts = { timeout: 30000, enableHighAccuracy: true};
		watchID = navigator.geolocation.watchPosition(onWatchSuccess, onError, opts);
	
		Start();
		}

	//checkIfFileExists("locdata.txt");
	//if (dataex==0)
	//	{WriteData();}	

	//ReadData();
	//setmypos();
	//DrawUsers();
	}


function onSuccess(position) 
	{
	console.log("on success");
	document.getElementById("GPS_search_screen").style.display="none";
	var element = document.getElementById('geopos');
	element.innerHTML = 'Latitude: '           + position.coords.latitude              + '<br />' +
                            'Longitude: '          + position.coords.longitude             + '<br />';
                            //'Altitude: '           + position.coords.altitude              + '<br />' +
                            //'Accuracy: '           + position.coords.accuracy              + '<br />' +
                            //'Heading: '            + position.coords.heading               + '<br />' +
                            //'Speed: '              + position.coords.speed                 + '<br />';
	MyLat=position.coords.latitude ;
	MyLong=position.coords.longitude ;
	MyAlt=position.coords.altitude ;
	MyHead=position.coords.heading ;
	MySpeed=position.coords.speed ;
	MyAcc=position.coords.accuracy;

	wlon=MyLong;
	wlat=MyLat;
	console.log("on succ, sett long");

	if (started==0 && MyUser!="nouser")	{Start();}

	setmypos();
//	document.getElementById('geopos_short').innerHTML="<table width=100% cellspacing=0><tr><td>Accuracy: "+MyAcc+"</td><td>Altitude: "+MyAlt+"</td></tr></table>";
	
    }

   
 
function getpos()
	{
		console.log("get pos");
	document.getElementById('geopos').innerHTML="Finding geolocation...";
	 navigator.geolocation.getCurrentPosition(onSuccess, onError);
	
	}


function onWatchSuccess(position) 
	{

	console.log("on watch success");

	MyLat=position.coords.latitude ;
	MyLong=position.coords.longitude ;
	MyAlt=position.coords.altitude ;
	MyHead=position.coords.heading ;
	MySpeed=position.coords.speed ;
	MyAcc=position.coords.accuracy  ;
	if (inpause==0)
		{
		var element = document.getElementById('geopos');
		element.innerHTML = 'Latitude: '           + position.coords.latitude              + '<br />' +
							'Longitude: '          + position.coords.longitude             + '<br />';
//							'Altitude: '           + position.coords.altitude              + '<br />' +
//							'Accuracy: '           + position.coords.accuracy              + '<br />' +
//							'Heading: '            + position.coords.heading               + '<br />' +
//							'Speed: '              + position.coords.speed                 + '<br />';
	
		setmypos();	
	//	document.getElementById('geopos_short').innerHTML="<table width=100% cellspacing=0><tr><td>Accuracy: "+MyAcc+"</td><td>Altitude: "+MyAlt+"</td></tr></table>";
	
		}
	}

    </script>
  </head>
  <style>
	body {color:white; margin:0px; padding:0px;}
	a {text-decoration:none; color:white;}
  </style>
  <body bgcolor=black>
  				
		<!--<div style='width:256px; height:256px; position:relative; position:absolute; left:0px; top:0px; z-index:99;' >
			<img   id='myimg' style='width:256px; height:256px;'>
			<div style='position:absolute; left:0px; top:0px; background-color:red; width:7px; height:7px;' id='persona'></div>
		</div>-->

	<div id='fanjara' style='position:relative; overflow:hidden; width:400px; height:600px;'>
		
<div  style='position:fixed; left:0px; top:0px; width:100%; height:50px; background-color:white; z-index:211; ' >
	<a style='float:left; margin-top:7px; margin-left: 7px;'  href='Javascript: show_settings();'><img src='but_info.png'></a>
<!--	<div id='infodiv' style='float:right;  color:Black; display:none;'></div>-->
	<a style='float:right; margin-top:7px; margin-right: 7px; ' href='Javascript: show_settings();' id='regbut' ><img src='but_register.png'></a>


</div>
		<!-- MAIN MAP -->
	<div id='charcho' style='position:fixed; left:0px; top:50px; width:365px; height:600px;  z-index:1;' >
		<div id='mainw' style='position:absolute; left:0px; top:0px; width:600px; height:600px; ' >
			<div id='map' style='position:absolute; left:0px; top:0px; width:600px; height:600px; display:block; ' >

				<div id='users' style='position:absolute; left:0px; top:0px;  z-index:101; '>
					<div id='homepos' style='position:absolute; left:0px; top:0px;  background-color:green; width:7px; height:7px; z-index:102;'><img src='pin.svg' style='position:absolute; left:-15px; top:-17px; width:30px; height:35px;'></div>
					<div id='taxibox'  style=' position:absolute; left:0px; top:0px; color:red; font-size:12px; width:50px; height:50px;  z-index:103;'>
						<div style='position:absolute; left:-25px; top:-25px; width:50px; height:50px; z-index:104;'>
							<img src='car.svg' style='width:50px; height:50px;'>
						</div>
						<div id='taxitext' style='position:absolute; left:-40px; top:25px;  width:70px; text-align:center;'></div>
					</div>
				</div>

			</div>
		</div>
	</div>



	<div id='arrived_screen'  style='display:none; position:fixed; top:50px; left:0px;  width:400px; height:620px; z-index:300; background-color:black; color:white; '>
	
		<br><br><br><br><br><br><br><br><br><br><br><center>თქვენი ტაქსი ადგილზეა<br><Br><a href='javascript: chamovdivar();' style='color:white; background-color:green; padding:10px; text-align:center; '>ჩამოვდივარ</a></center>
		<br><br><center>
		<div id='taxi_number' style='color:white;'></div>
	</div>
	

<div id='GPS_search_screen'  style='display:inline; position:fixed; top:0px; left:0px;  width:365px; height:650px; z-index:301; background-color:black; color:white; '><br><br><br><br><br><br><br><br><center> <img src='taxi_icon.png'><br><br>... მიმდინარეობს თქვენი ლოკაციის დადგენა ...</center></div>

	<div id='taxi_search_screen'  style='display:none; position:fixed; top:0px; left:0px;  width:365px; height:650px; z-index:302; background-color:black; color:white; '><br><br><br><br><br><br><br><br><center> <img src='taxi_icon.png'><br><br>... უახლოესი თავისუფალი ტაქსის ძიება ...</center></div>


		<!-- MOUSE OVER LAYER -->
<div id='mouser' style='position:fixed; left:0px;top:50px; border:1px solid red; width:365px; height:500px; z-index:500; -ms-touch-action: none;  ' ontouchstart="mdown(event);" ontouchend="mup(event);"  ontouchmove="getmousecoord(event);" >
</div>


		<!--<div id='profile_div' style='position:absolute; left:0px; top:0px; width:600px; height:600px; z-index:252; background:URL(semitrans.png); visibility:hidden;'>
			<table width=100% cellspacing=0 cellpadding=0 height=100% border=1>
				<tr><td onmouseup='hide_profile();' onclick="hide_profile();" colspan=3></td></tr>
				<tr><td onmouseup='hide_profile();' onclick="hide_profile();"></td>
				<td>
					<img src='http://design.ge/geotaxi/taxicar.jpg' width=100px><br>
					&#4315;&#4304;&#4316;&#4325;&#4304;&#4316;&#4312;&#4321;&#32;&#4315;&#4317;&#4307;&#4308;&#4314;&#4312;: Mercedes<br>
					მანქანის ფერი: მწვანე<br>
					მძღოლი: ანდრო შველიძე<br>
					<a href='Javascript: call_taxi()'>გამოძახება</a>
				</td>
				<td onmouseup='hide_profile();' onclick="hide_profile();"></td></tr>
				<tr><td onmouseup='hide_profile();' onclick="hide_profile();" colspan=3></td></tr>
				</table>
		</div>-->
		
		<!--<div id="geopos_short" style='width:100%; position:absolute; left:0px; top:50px; z-index:220; background-color:black; filter: alpha(opacity=50);
			-moz-opacity: 0.5; -khtml-opacity: 0.5;  opacity: 0.5;'>Finding geolocation...</div>-->

		

	<div id='chat_div' style='position:fixed; right:10px; bottom:50px; z-index:304; border:1px solid red; '>
		<a href='Javascript: chat_click();' style='position:absolute; top:-25px; right:0px;'><img src='chat.svg' style='width:50px; height:50px;'></a>
		<div id='chat_window' style='display:inline; width:98%; height:200px; background-color:white; display:none;'>
			<div id='chat_txt' style='width:99%; border:1px solid gray; height:150px; overflow:auto; background-color:white; color:black;'>kkk</div>
			<input type='text' size=30 id='chat_send_text' style='z-index:305;'><input type='button' value='send' onclick='chat_send();' style='z-index:305;'>
		</div>
	</div>

	<a id='call_but'  style='position:fixed; bottom:0px; left:80px; height:100px; width:210px; z-index:252; border:1px solid red; ' href='Javascript: call_taxi();'><img src='gamodzaxeba.svg' style='width:210px; height:100px;'></a>


	
<!--<a href='Javascript:zoomme(1);' style='position:fixed; bottom:85px; left:5px; margin:5px; z-index:252;'><img src='zoomin.png'></a>
<a href='Javascript:zoomme(-1);'style='position:fixed; bottom:45px; left:5px; margin:5px; z-index:252;'><img src='zoomout.png'></a>-->
<a href='Javascript: setme();' style='position:fixed; top:60px; right:leftpx; margin:5px; z-index:252; ' ><img id='cbut' src='center.svg' style='width:50px; height:50px;'></a>
<!--<a href='Javascript: show_settings();' style='position:fixed; top:55px; right:5px; margin:5px; z-index:252;' ><img src='settings.png'></a>-->



		<div id="bottom_menu" style=' width:100%; position:fixed; bottom:0px; left:0px; height:41px; z-index:251; background-color:#3f3f3f; filter: alpha(opacity=90);	-moz-opacity: 0.9; -khtml-opacity: 0.9;  opacity: 0.9;   border:1px solid red;' >
			<img src='phone.png'>
			<div id='info_text' name='info_text' style=' float:right; color:white; padding:5px; '></div>
		</div>

	</div>

	   			<!--<table width=100% cellpadding=0 cellspacing=0>
			<tr><Td align=left><a href='Javascript:zoomme(1);' style='float:left; font-size:30px; margin:5px;'><img src='zoomin.png'></a></td>
			<td align=center><a href='Javascript: setme();' style='margin:5px; ' ><img id='cbut' src='centeroff.png'></a></td>
			<Td align=center><a href='Javascript: show_settings();' style='margin:5px;'><img src='settings.png'></a></td>
			<td align=right><a href='Javascript:zoomme(-1);' style='float:right; margin:5px;   '><img src='zoomout.png'></a></td>
			</table>-->




	<div id='settings_sheet' style='visibility:hidden; position:absolute; left:0px; top:0px; padding:10px;'>
		<br>
		<div id='mydiv'></div>
		<br>
		<p id="geopos">Finding geolocation...</p>

	<b>რუქის ტიპი</b><br>
	<select id='maptype' onChange='changemap();'>
	<option value='1' >Open Street Map (fast)</option>
	<option value='2'>Open Cycle Map (slow)</option>
	<option value='3' selected>Google Sattelite (fast)</option>
	<option value='4'>Google Hybrid (fast)</option>
	<option value='5'>Google Terrain (fast)</option>
	<option value='6'>Google BLACK Strange 1 (very fast)</option>
	<option value='7'>Google BLACK Strange 2 (fast)</option>
	<option value='8'>Wiki MAP (slow)</option>
	<option value='9'>Watercolor Map (very slow)</option>
	<option value='10'>Toner MAP (slow)</option>
	</select>
	<br><br>
		<div id='erorebi'>Tilebi (zoom:16)</div>
	
		
		<b>პროფილი</b>
		<table>
			<tr><td>მომხმ.:</td><td> <input id='myname' name='myname' value='youuser' size=12></td></tr>
			<tr><td>პაროლი:</td><td> <input id='mypass' name='mypass' value='yourpass' size=12></td>
			<td rowspan=2><a style='' href='Javascript: saveuser();'><img src='save.png'></a></td></tr>
		</table>
		<a href='javascript: regme();'>რეგისტრაცია</a>
		<br><br>
		<input type='checkbox' id='ignor_cache' name='ignor_cache' onchange='cignore();'> რუქის ქეშის იგნორირება<br>
		<input type='checkbox' id='ignor_cache_on_wifi' name='ignor_cache_on_wifi' onchange='cignorewifi();' checked> რუქის ქეშის იგნორირება WiFi-სას<br>
		<a href='Javascript: show_map();'>Back</a>
	</div>


<script>
var last_chat=0;
var chatopened=0;
function chat_click()
	{
	if (chatopened==0)
		{
		document.getElementById("chat_window").style.display="inline";
		document.getElementById("chat_div").style.bottom="70px";
		chatopened=1;
		}
	else	
		{
		document.getElementById("chat_window").style.display="none";
		document.getElementById("chat_div").style.bottom="60px";
		chatopened=0;
		}

	}

function chat_send()
{
chat_txt=document.getElementById("chat_send_text").value;
document.getElementById("chat_send_text").value="";
url="http://design.ge/geotaxi/chat.php?send=1&myid="+myid+"&chat_txt="+chat_txt;
console.log("send chat: "+url);
gamehttp.open('GET',url,true);
gamehttp.send(null);
}

function change_status(newstat)
{
console.log("status change: "+newstat+ " / "+mystatus);
if (newstat!=mystatus)
	{

	if (newstat==1)
		{

		uplimit=1;
		document.getElementById("taxi_search_screen").style.display="inline";
		document.getElementById("info_text").innerHTML="მიმდინარეობს ტაქსის ძიება";
		document.getElementById("call_but").style.display="none";
		document.getElementById("arrived_screen").style.display="none";
		}
	else if (newstat==2)
		{
		document.getElementById("taxi_search_screen").style.display="none";
		uplimit=1;
		document.getElementById("call_but").style.display="none";
		document.getElementById("info_text").innerHTML="ტაქსი მოდის";
		myself=1;
		}
	else if (newstat==3)
		{
		uplimit=1;
		document.getElementById("taxi_search_screen").style.display="none";
		document.getElementById("call_but").style.display="none";
		document.getElementById("arrived_screen").style.display="inline";
		document.getElementById("taxi_number").innerHTML="ბორტის ნომერი: "+taxiname;
		myself=1;
		}
	else if (newstat==4)
		{
		uplimit=1;
		document.getElementById("taxi_search_screen").style.display="none";
		document.getElementById("call_but").style.display="none";
		document.getElementById("arrived_screen").style.display="none";
		document.getElementById("info_text").innerHTML="ტაქსი გელოდებათ, ბორტი: "+taxiname;

		myself=1;
		}
	else if (newstat==5)
		{
		uplimit=5;
		document.getElementById("taxi_search_screen").style.display="none";
		document.getElementById("call_but").style.display="none";
		document.getElementById("arrived_screen").style.display="none";
		document.getElementById("info_text").innerHTML="თქვენ მოძრაობთ";
		myself=1;
		}

	else if (newstat==0)
		{
		uplimit=5;
		document.getElementById("call_but").style.display="inline";
		document.getElementById("taxi_search_screen").style.display="none";
		document.getElementById("arrived_screen").style.display="none";
		}	
	mystatus=newstat;
	}

		
}

function chamovdivar()
{
if (MyUser!="nouser")
		{    
		url="http://design.ge/geotaxi/chamovdivar.php?uname="+MyUser+"&pass="+MyPass+"&lat="+MyLat+"&long="+MyLong+"&unique="+myid;		
		}
	else
		{
		url="http://design.ge/geotaxi/chamovdivar.php?lat="+MyLat+"&long="+MyLong+"&unique="+myid;
		}
	console.log("taxi chamovdivar: "+url);
	gamehttp.open('GET',url,true);
	gamehttp.send(null);

}

function cignore()
	{
	if (document.getElementById("ignor_cache").checked==true)
		{	cache_ignore=1;	}
	else
		{	cache_ignore=0;	}
	}

function cignorewifi()
	{
	if (document.getElementById("ignor_cache_on_wifi").checked==true)
		{	cache_ignore_wifi=1;	}
	else
		{	cache_ignore_wifi=0;	}
	}

function setme()
	{
		console.log("setme");
	if(myself==0)
		{myself=1; document.getElementById("cbut").src='center_sel.svg';}
	else {myself=0;document.getElementById("cbut").src='center.svg';}

	}

document.getElementById("maptype").value=1;
var curmap=1;

function changemap()
	{
		console.log("change map");
	curmap=document.getElementById("maptype").value;
	oxt=0;oyt=0;
	setmypos();
	}

var curwindow=0;

function show_settings()
	{

	checkConnection();

	curwindow=1;
	document.getElementById("fanjara").style.visibility="hidden";
	document.getElementById("settings_sheet").style.visibility="visible";
	}


function show_map()
	{
	curwindow=0;
	document.getElementById("fanjara").style.visibility="visible";
	document.getElementById("settings_sheet").style.visibility="hidden";
	}


function stopScrolling( touchEvent )
			{ touchEvent.preventDefault(); }


//document.body.addEventListener( 'touchmove' , stopScrolling , false );
var mcl="orange";


function DrawUsers()
	{

	if (mystatus==2)
		{
		var x=long2pixel(taxilong, MyZoom);
		var y=lat2pixel(taxilat, MyZoom);

		console.log("draw taxi: "+taxilong+ " / "+taxilat+ " onme:"+myself);

		var difx=Math.floor((x-xtile)*256);
		var dify=Math.floor((y-ytile)*256);
		difx=(256*(myw-1)/2)+difx-128;
		dify=(256*(myh-1)/2)+dify-128;
		
		document.getElementById("taxibox").style.left=difx+"px";
		document.getElementById("taxibox").style.top=dify+"px";
		document.getElementById("taxibox").style.visibility="visible";
		document.getElementById("taxitext").innerHTML=taxiname;

		console.log("draw taxi: "+difx+ " / "+dify+" taxiname: "+taxiname);
		}
	}



function DrawHomePos()
	{
	console.log("drawing home pos");
	var x=long2pixel(MyLong, MyZoom);
	var y=lat2pixel(MyLat, MyZoom);

	var difx=Math.floor((x-xtile)*256);
	var dify=Math.floor((y-ytile)*256);
	difx=(256*(myw-1)/2)+difx-128;
	dify=(256*(myh-1)/2)+dify-128;
	
	document.getElementById("homepos").style.left=(difx-2)+"px";
	document.getElementById("homepos").style.top=(dify-2)+"px";

	}


var but1=0;

var t2x=0;
var t2y=0;

var tdist=0;
var tdist_old=0;


function mdown(event)
	{

	omousex=parseInt(event.touches[0].pageX); 
	omousey=parseInt(event.touches[0].pageY);
	console.log(event.touches.length+"mouse down: "+omousex+ " - "+omousey);
	if (event.touches.length>1)
		{
		t2x=parseInt(event.touches[1].pageX);
		t2y=parseInt(event.touches[1].pageY);
		tdist_old=Math.sqrt( Math.pow ((t2x-omousex),2) + Math.pow ((t2y-omousey),2) );
		tdist=Math.sqrt( Math.pow ((t2x-omousex),2) + Math.pow ((t2y-omousey),2) );
		tdist_old=parseInt(tdist_old);
		tdist=parseInt(tdist);
		console.log(" dva: "+t2x+ " - "+t2y);
		console.log(" tdist: "+tdist_old +" - " +tdist );
		}


	finx=0; sfiny=0;
	but1=1;

//	document.getElementById("mainb").innerHTML="X: "+omousex+" Y: "+omousey;
	}

var biji = new Array();
biji[2]=2;
biji[3]=7;
biji[4]=12;
biji[5]=25;
biji[6]=45;
biji[7]=90;
biji[8]=200;
biji[9]=360;
biji[10]=700;
biji[11]=1400;
biji[12]=2900;
biji[13]=5800;
biji[14]=11500;
biji[15]=23500;
biji[16]=46500;
biji[17]=93000;
biji[18]=190000;

var sfinx=0;
var finy=0;

function getmousecoord(event)
	{
	console.log("get mouse coord movedi");
	
	if (event.targetTouches.length>1)
		{
		t2x=parseInt(event.targetTouches[1].pageX);
		t2y=parseInt(event.targetTouches[1].pageY);
		mousex=parseInt(event.targetTouches[0].pageX); 
		mousey=parseInt(event.targetTouches[0].pageY);
		console.log("get mouse coord on move: "+mousex+" - "+mousey);
		console.log("get mouse dva on move: "+t2x+" - "+t2y);
		tdist=Math.sqrt( Math.pow ((t2x-omousex),2) + Math.pow ((t2y-omousey),2) );

		tdist=parseInt(tdist);
		console.log(" tdist on move: "+tdist_old +" - " +tdist );
		
		}
	else
		{
		if (but1==1)
			{
			
			
			mousex=event.touches[0].pageX; 
			mousey=event.touches[0].pageY;
		
			console.log("get mouse coord: "+mousex+" - "+mousey);

			wlon=wlon+((omousex-mousex)/biji[MyZoom]);
			wlat=wlat-((omousey-mousey)/(biji[MyZoom]*1.3));
			omousex=mousex;
			omousey=mousey;

			//
			setmypos();
			DrawUsers();
				
			}
		}
	}

function mup(event)
	{
	console.log("mouse up");

	if (event.touches.length>1)
		{
		t2x=parseInt(event.touches[1].pageX);
		t2y=parseInt(event.touches[1].pageY);
		tdist_old=Math.sqrt( Math.pow ((t2x-omousex),2) + Math.pow ((t2y-omousey),2) );
		tdist=Math.sqrt( Math.pow ((t2x-omousex),2) + Math.pow ((t2y-omousey),2) );
		tdist_old=parseInt(tdist_old);
		tdist=parseInt(tdist);
		console.log(" dva on up: "+t2x+ " - "+t2y);
		console.log(" tdist on up: "+tdist_old +" - " +tdist );
		}
	but1=0;
	sfinx=0; sfiny=0;
	check_user_click();
	t2x=0; t2y=0;
	tdist=0;
	tdist_old=0;
	//document.getElementById("mainb").innerHTML="Up";
	}


var myw=Math.floor(sx/256)+2;
var myh=Math.floor(sy/256)+2;

if (myw/2==Math.floor(myw/2))
	{myw++;}

if (myh/2==Math.floor(myh/2))
	{myh++;}
document.ontouchmove = function (e) {  console.log("object: "+e.target.id);};


document.getElementById("fanjara").style.width=sx+"px";
document.getElementById("fanjara").style.height=sy+"px";

document.getElementById("mouser").style.width=sx+"px";
document.getElementById("mouser").style.height=sy+"px";


var mywpx=(myw-1)*256;
var myhpx=(myh-1)*256;

document.getElementById("mainw").style.width=mywpx+"px";
document.getElementById("mainw").style.height=myhpx+"px";
console.log(" x: "+mywpx+ " Y: "+myhpx);
document.getElementById("map").style.width=mywpx+"px";
document.getElementById("map").style.height=myhpx+"px";
document.getElementById("mainw").style.left=(-(mywpx-(sx))/2)+"px";
document.getElementById("mainw").style.top=(-(myhpx-(sy))/2)+"px";

canacX=(-(mywpx-(sx))/2);
canacY=(-(myhpx-(sy))/2);

console.log(" x: "+(-(mywpx-(sx))/2)+ " Y: "+(-(myhpx-(sy))/2));
//document.getElementById("mainb").style.left=((sx-200)/2)+"px";


function zoomme(sait)
	{
		console.log("zoome "+sait)
	var cant=0;
	if (sait>0 && MyZoom==18)
		{cant=1;}
	else if (sait<0 && MyZoom==2)
		{cant=1;}
	if (cant==0)
		{	
		MyZoom=Math.floor(MyZoom)+sait;
	//	document.getElementById("mainb").innerHTML="Zoom: "+MyZoom;
		setmypos();
		DrawUsers();
		}
	}



function saveuser()
	{

	MyUser=document.getElementById("myname").value;
	MyPass=document.getElementById("mypass").value;

	WriteData(); 
	alert("user saved: "+MyUser);
	if(started==0)
		{
		Start();
		}
	}


var curx;
var cury;
var mymap=document.getElementById("map");
//mymap.innerHTML="";
//mymap.innerHTML+="<div id='users' style='position:absolute; left:0px; top:0px; border:1px solid red; z-index:101;'><div id='homepos' style='position:absolute; left:0px; top:0px; border:1px solid red; background-color:green; width:7px; height:7px; z-index:99;'></div></div>";

for (i=0;i<myw ; i++)
	{
	curx=i-(myw-1)/2;
	for (ii=0;ii<myh ;ii++ )
		{
		cury=ii-(myh-1)/2;
		mymap.innerHTML+="<img id='img_"+i+"-"+ii+"' style='position:absolute; left:"+(i*256-128)+"px; top:"+(ii*256-128)+"px; width:256px; height:256px;'>";
		}
	}
//mymap.innerHTML+="				<div style='position:absolute; background-color:red; width:5px; height:5px; left:300px; top:300px;'></div>";
var oxt=0;
var oyt=0;
var tilef=0;

var kartX;
var kartY;

function setmypos()
	{
 
	console.log("set my pos, zoom: "+MyZoom);

	if (MyZoom>18 || MyZoom<1)
		{
			MyZoom=17;
		}

	var lon_deg=wlon; 
	var lat_deg=wlat; 

	xtile=long2tile(lon_deg, MyZoom);
	ytile=lat2tile(lat_deg, MyZoom);

	var x=long2pixel(lon_deg, MyZoom);
	var y=lat2pixel(lat_deg, MyZoom);
	
	var difx=128-(x-xtile)*256;
	var dify=128-(y-ytile)*256;
	kartX=difx;
	kartY=dify;

	console.log("mypos: "+lon_deg+" / "+lat_deg+ " = "+difx+" / "+dify);

	document.getElementById("map").style.left=difx+"px";
	document.getElementById("map").style.top=dify+"px";

	if (xtile!=oxt || oyt!=ytile)
		{
		oxt=xtile;
		oyt=ytile;
		cur_down_i=0;
		cur_down_ii=-1;
		down_complete=1;
		check_complete=1;
		file_downing=1;
		LT_finished=0;
		loadtiles();	
		DrawHomePos();
		}
//	document.getElementById("infodiv").innerHTML=wlon+ " / "+wlat;
	}

function check_user_click()
	{
//	console.log("checking user click");
//	console.log((omousex-canacX-kartX) + " and " + (omousey-canacY-kartY));
return;
	for (i=0;i<userids.length ;i++ )
		{
		curid=userids[i];

		var x=long2pixel(userlongs[i], MyZoom);
		var y=lat2pixel(userlats[i], MyZoom);
	
		var difx=Math.floor((x-xtile)*256);
		var dify=Math.floor((y-ytile)*256);
		difx=(256*(myw-1)/2)+difx-128;
		dify=(256*(myh-1)/2)+dify-128;
		if ( (difx-16)<(omousex-canacX-kartX) && (omousex-canacX-kartX)<(difx+16) &&  (dify-16)<(omousey-canacY-kartY) && (omousey-canacY-kartY)<(dify+16) )
			{
			show_profile(i);
			}
		}
	}

function hide_profile()
	{
	document.getElementById("profile_div").style.visibility="hidden";
	document.getElementById("mouser").style.visibility="visible";
	curtaxi=-1;
	}
var curtaxi=-1;

function show_profile(tid)
	{
	var curtaxi=tid;
	document.getElementById("profile_div").style.visibility="visible";
	document.getElementById("mouser").style.visibility="hidden";
	}

function call_taxi()
	{
	if (MyUser!="nouser")
		{    
		url="http://design.ge/geotaxi/call.php?uname="+MyUser+"&pass="+MyPass+"&lat="+MyLat+"&long="+MyLong+"&unique="+myid;		
		}
	else
		{
		url="http://design.ge/geotaxi/call.php?lat="+MyLat+"&long="+MyLong+"&unique="+myid;
		}
	console.log("taxi call: "+url);
	gamehttp.open('GET',url,true);
	gamehttp.send(null);
	

	

	
	}

function loadtiles()
	{
	if (down_complete==1 && check_complete==1)
		{
		var A;

		if (cur_down_ii>=(myh-1))
			{
			cur_down_ii=-1; cur_down_i++;
			}

		curx=cur_down_i-(myw-1)/2;
	
		if (cur_down_i<myw)
			{
			cur_down_ii++;
			
			cury=cur_down_ii-(myh-1)/2;
		//	alert("checking: "+curmap+"_"+MyZoom+"_"+(xtile+curx)+"_"+(ytile+cury)+".png");
			
			A=(xtile+curx);	if (A<0) {A=0;}
			mytile=curmap+"/"+MyZoom+"_"+A+"_"+(ytile+cury)+".png";

			tilef=-1;
			check_complete=0;down_complete=0;
			checktile3(mytile);

			}
		else
			{
			// cikli dasrulda
			LT_finished=1;
			console.log("-------- dasrulda ----------");

			
			DrawHomePos();
			}
		}
	else if (check_complete==1)
		{
		curx=cur_down_i-(myw-1)/2; cury=cur_down_ii-(myh-1)/2;
		A=(xtile+curx);	if (A<0) {A=0;}
		mytile=curmap+"/"+MyZoom+"_"+A+"_"+(ytile+cury)+".png";

		//if (tilef==0 || cache_ignore==1 || (cache_ignore_wifi==1 && inter=="Wifi"))
//			{
		//	if (file_downing==1)
		//		{
				file_downing=0;
				downtile(curmap, MyZoom, (xtile+curx), (ytile+cury), cur_down_i, cur_down_ii,1);
				down_complete=1;
				file_downing=1;
		//		}
//			}
//		else
//			{
//			document.getElementById("img_"+cur_down_i+"-"+cur_down_ii).src="file:///storage/emulated/0/mytaxi/maps/"+mytile;
//			document.getElementById("img_"+cur_down_i+"-"+cur_down_ii).alt=mytile;
//			down_complete=1;
//			file_downing=1;
			
//			DrawHomePos();
//			}
		}
		
	if (LT_finished==0)
		{
		//setTimeout("loadtiles();",10);
		}

	}


function downtile(smap, szoom, A, B, i, ii, retry)
	{
	if (A<0)
		{A=0;}
	if (B<0)
		{B=0;}

	if (smap==1)
		{tilelink="http://tile.openstreetmap.org/"+szoom+"/"+A+"/"+B+".png";			}
	else if (smap==2)
		{tilelink="http://tile.opencyclemap.org/cycle/"+szoom+"/"+A+"/"+B+".png";			}
	else if (smap==3)
		{tilelink="http://mt3.google.com/vt/lyrs=s&x="+A+"&y="+B+"&z="+szoom;}
	else if (smap==4)
		{tilelink="http://mt3.google.com/vt/lyrs=p&x="+A+"&y="+B+"&z="+szoom;}
	else if (smap==5)
		{tilelink="http://mt3.google.com/vt/lyrs=t&x="+A+"&y="+B+"&z="+szoom;}
	else if (smap==6)
		{tilelink="http://mt3.google.com/vt/lyrs=h&x="+A+"&y="+B+"&z="+szoom;}
	else if (smap==7)
		{tilelink="http://mt3.google.com/vt/lyrs=r&x="+A+"&y="+B+"&z="+szoom;}
	else if (smap==8)
		{
		s=A%4+(B%4)*4;
		tilelink="http://i"+s+".wikimapia.org/?x="+A+"&y="+B+"&zoom="+szoom+"&m=h";
		}
	else if (smap==9)
		{tilelink="http://tile.stamen.com/watercolor/"+szoom+"/"+A+"/"+B+".png";			}
	else if (smap==10)
		{tilelink="http://tile.stamen.com/toner/"+szoom+"/"+A+"/"+B+".png";			}	
	tilename=smap+"/"+szoom+"_"+A+"_"+B+".png";

	document.getElementById("img_"+i+"-"+ii).src=tilelink;
	console.log("down tile: "+tilelink);

	}

 function fail(error) 
	{
    console.log(error.code);
    }
//document.ontouchmove = function (e) {  console.log("object: "+e.target.id);};
//document.ontouchmove = function(e) {getmousecoord(e);};
//document.body.addEventListener('touchmove', function(event) {  event.preventDefault();}, false); 
</script></body>
</html>
